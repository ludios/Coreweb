<!doctype html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<!-- IE=9 prevents the user from turning on IE7 or IE8 compatibility mode -->
<meta http-equiv="X-UA-Compatible" content="IE=9" />
<title>{{ pageTitle }}</title>
</head>
<body>

<style>
div, p, body {
	font-size: 13px;
	font-family: Tahoma, sans-serif;
}
</style>

<a href="#" onclick="TestRunnerPage.toggleVisibility('TestRunnerPage-log');return false">Show/hide debug log</a><br>

<div id="TestRunnerPage-log" style="background-color:#ddd;display:none"></div>
<div id="TestRunnerPage-results" style="background-color:#ccc"></div>


<script>

var TestRunnerPage = {};
TestRunnerPage._abortExecution = true;
TestRunnerPage._abortMessage =
	"TestRunnerPage._abortExecution is true. " +
	"Check for errors on this test page in your JavaScript console.";
TestRunnerPage.timers = {};

/**
 * Clone just the property strings, ignore the values.
 * @return {'propertyname': true, ...} for each property in C{object}.
 */
TestRunnerPage.cloneProperties = function(object) {
	var c = {}, k;
	for(k in object) {
		c[k] = true;
	};
	return c;
}


TestRunnerPage.getNewProperties = function(oldSet, object) {
	var k;
	var newProps = [];
	for(k in object) {
		if(!oldSet[k]) {
			newProps.push(k);
		}
	}
	return newProps;
}


TestRunnerPage.toggleVisibility = function(id) {
	var e = document.getElementById(id);
	if(e.style.display == 'block' || !e.style.display) {
		e.style.display = 'none';
	} else {
		e.style.display = 'block';
	}
}


TestRunnerPage.logNewProps = function() {
	var newProps = TestRunnerPage.getNewProperties(TestRunnerPage.propsBefore, window);
	TestRunnerPage.logger.info('New window properties: ' + newProps.join(', '));
}


TestRunnerPage.startTests = function() {
	TestRunnerPage.logger.info('Running tests.');

	var modules = {{ moduleString }};
	var suite = cw.UnitTest.loadFromModules(modules);

	var outputDiv = document.getElementById('TestRunnerPage-results');
	var d = cw.UnitTest.runWeb(suite, outputDiv);
	d.addCallback(TestRunnerPage.logNewProps);
}



// Enumerate properties now and check for new ones later, to
// to make sure there's very little `window` pollution besides
//`TestRunnerPage` and `CW`.

// We look at the properties before we even load the <script>,
// in case there's a bug that leaks a variable at the top-level scope of the script.
TestRunnerPage.propsBefore = TestRunnerPage.cloneProperties(window);

TestRunnerPage.timers.scriptLoadStart = +new Date; /* scripts begin */


window.CLOSURE_NO_DEPS = true;

// Stopping all script execution if there's an error above is good. We could use just
// one <script> on this page to achieve that effect, but then we don't get timing
// information about how long it takes for the scriptContent to parse (because it's
// already parsed as we're in the <script>). So we use three <script>s and check for
// a failure condition.

TestRunnerPage._abortExecution = false;

</script>
<script>

if(TestRunnerPage._abortExecution) {
	throw new Error("[0] " + TestRunnerPage._abortMessage);
}

{{ scriptContent }}

</script>
<script>

/*
 * Set up the Firebug console as a log observer.
 */
if (!goog.debug.Console.instance) {
	goog.debug.Console.instance = new goog.debug.Console();
}

goog.debug.Console.instance.setCapturing(true);


TestRunnerPage._htmlFormatter = new goog.debug.HtmlFormatter();

TestRunnerPage._debugLogDiv = document.getElementById('TestRunnerPage-log')
TestRunnerPage._htmlLogOutput = function(logRecord) {
	var htmlString = TestRunnerPage._htmlFormatter.formatRecord(logRecord);

	var span = document.createElement("span");
	span.innerHTML = htmlString;
	TestRunnerPage._debugLogDiv.appendChild(span);
}
goog.debug.LogManager.getRoot().addHandler(TestRunnerPage._htmlLogOutput);


// This assumes goog.debug.Logger was included in scriptContent. Maybe a bad assumption.

TestRunnerPage.logger = goog.debug.Logger.getLogger('TestRunnerPage');
TestRunnerPage.logger.setLevel(goog.debug.Logger.Level.ALL);

if(TestRunnerPage._abortExecution) {
	throw new Error("[1] " + TestRunnerPage._abortMessage);
}

TestRunnerPage.timers.scriptLoadEnd = +new Date; /* scripts end */

TestRunnerPage.logger.info(
	"Took " + (TestRunnerPage.timers.scriptLoadEnd - TestRunnerPage.timers.scriptLoadStart) +
	" ms to load scripts.");

window.onload = TestRunnerPage.startTests;

</script>

<br>

<!-- no need to close -->
