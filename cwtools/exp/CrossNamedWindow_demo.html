<!doctype html>
<html>
<head>
	<meta http-equiv="charset" content="text/html; charset=utf-8">
	<title></title>
	<style>
		{{ getTestPageCSS() }}
	</style>
</head>
<body>

<div id="doc">This page is a demo of <code>cw.crosstab.CrossNamedWindow</code>.
You'll want to open multiple tabs/windows to this page to see anything useful.
</div>

<br>

Send text to master, or to all slaves:
<input type="text" name="textinput" id="textinput">
<input type="submit" value="Send"
	onclick="cnwdemo.sendText(document.getElementById('textinput').value);return false">

<br><br>

<div id="log"></div>

<script>CLOSURE_NO_DEPS = true;</script>
<script src="/JSPATH/closure/goog/base.js"></script>
<script src="/JSPATH/all_deps.js"></script>

<script>
goog.provide('cnwdemo');

goog.require('goog.array');
goog.require('goog.debug.DivConsole');
goog.require('goog.debug.Logger');
goog.require('goog.string');

goog.require('cw.autoTitle');
goog.require('cw.repr');
goog.require('cw.crosstab');
</script>

<script>
var logDiv = document.getElementById('log');
var divConsole = new goog.debug.DivConsole(logDiv);
divConsole.setCapturing(true);

var logger = goog.debug.Logger.getLogger('logger');
logger.setLevel(goog.debug.Logger.Level.ALL);

logger.info('Logger works.');


/**
 * @constructor
 */
cnwdemo.Demo = function() {
	/**
	 * @type {!Array.<!cw.crosstab.CrossNamedWindow>}
	 */
	this.slaves_ = [];

	/**
	 * @type {cw.crosstab.CrossNamedWindow}
	 */
	this.master_ = null;
};

cnwdemo.Demo.prototype.gotMaster_ = function(ev) {
	logger.info('Got master: ' + cw.repr.repr(ev.master));
	this.master_ = ev.master;
};

cnwdemo.Demo.prototype.lostMaster_ = function(ev) {
	logger.info('Lost master');
	this.master_ = null;
};

cnwdemo.Demo.prototype.becameMaster_ = function(ev) {
	logger.info('Became master');
};

cnwdemo.Demo.prototype.newSlave_ = function(ev) {
	logger.info('New slave: ' + cw.repr.repr(ev.slave));
	this.slaves_.push(ev.slave);
};

cnwdemo.Demo.prototype.lostSlave_ = function(ev) {
	logger.info('Lost slave: ' + cw.repr.repr(ev.slave));
		this.slaves_.push(ev.slave);
	var ret = goog.array.remove(this.slaves_, ev.slave);
	if(!ret) {
		throw Error("cnwdemo.Demo didn't know about slave " + ev.slave);
	}
};

cnwdemo.Demo.prototype.message_ = function(ev) {
	logger.info('Got message: ' + cw.repr.repr(ev.message));
};

/**
 * @param {string} text
 */
cnwdemo.Demo.prototype.sendTextToSlaves = function(text) {
	for(var i=0; i < this.slaves_.length; i++) {
		var slave = this.slaves_[i];
		slave.message(text);
	};
	logger.info('Sent ' + cw.repr.repr(text) + ' to ' + this.slaves_.length + ' slave(s)');
};

/**
 * @param {string} text
 */
cnwdemo.Demo.prototype.sendTextToMaster = function(text) {
	this.master_.message(text);
	logger.info('Sent ' + cw.repr.repr(text) + ' to master');
};

cnwdemo.Demo.prototype.start = function() {
	var cnw = cw.crosstab.theCrossNamedWindow;
	cnw.addEventListener(cw.crosstab.EventType.GOT_MASTER, this.gotMaster_, false, this);
	cnw.addEventListener(cw.crosstab.EventType.LOST_MASTER, this.lostMaster_, false, this);
	cnw.addEventListener(cw.crosstab.EventType.BECAME_MASTER, this.becameMaster_, false, this);
	cnw.addEventListener(cw.crosstab.EventType.NEW_SLAVE, this.newSlave_, false, this);
	cnw.addEventListener(cw.crosstab.EventType.LOST_SLAVE, this.lostSlave_, false, this);
	cnw.addEventListener(cw.crosstab.EventType.MESSAGE, this.message_, false, this);

	cnw.start();
};

/**
 * @param {string} text
 */
cnwdemo.sendText = function(text) {
	if(cw.crosstab.theCrossNamedWindow.isMaster()) {
		cnwdemo.lastDemo.sendTextToSlaves(text);
	} else {
		cnwdemo.lastDemo.sendTextToMaster(text);
	}
};


cnwdemo.start = function() {
	cnwdemo.lastDemo = new cnwdemo.Demo();
	cnwdemo.lastDemo.start();
};

cnwdemo.start();

</script>
</body>
</html>
