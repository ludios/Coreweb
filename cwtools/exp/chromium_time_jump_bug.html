<!doctype html>
<html>
<head>
	<meta http-equiv="charset" content="text/html; charset=utf-8">
	<title>Chromium backwards time jump</title>
	<style>
		* {
			font-family: Verdana, sans-serif;
			font-size: 13px;
		}
		pre, code {
			font-family: Consolas, monospace;
			font-size: 0.8em;
		}
		body, html {
			background-color: #eee;
		}
		#log {
			white-space: pre;
		}
		#doc {
			white-space: pre-wrap;
		}
	</style>
</head>
<body>

<button style="float:right" value="Force printout" onclick="forcePrintout()"></button>
<div id="doc">
Chromium doesn't seem to handle backwards time jumps very well, but the behavior is especially strange on Windows.

Steps to reproduce on Windows:
	1. Open this page, observe normal behavior.
	2. Move the Windows system clock back 2 minutes.
	3. Observe:
		1. The timers print normally for another 40-50 seconds.
		2. The timers stop for 1-3 minutes.
		3. The timers resume again.

I reproduced this Chromium/Windows bug on:
	Chrome 4.0.249.89 (38071) on Windows Server 2008 R2 on bare metal, Core 2 Q6600
	Chrome 4.1.249.1025 beta (40600) on XP SP3 32-bit on VMWare Workstation 7.0.1
	Chrome 5.0.342.2 dev on XP SP2 64-bit on VMWare Workstation 7.0.1

On 2008 R2, I even see a really strange time correction like:
[57.023s] 1267991372772
[58.023s] 1267991373772
--- no timers fired for 2 minutes here ---
[180.433s] 1267991496182
[60.023s] 1267991375772
[61.024s] 1267991376773


Steps to reproduce on Ubuntu or OS X:
	1. Same as above, but observe:
		1. The timers stop for however many minutes you moved the clock back.
		2. The timers resume again.

I reproduced this Chromium/(Linux|Mac) bug on:
	Ubuntu 9.10 32-bit in VMWare Workstation 7.0.1
	Mac OS X 10.6.2


Note: On Windows, IE8, Firefox 3.6, Firefox 2.0.0.20, and Opera 10.50 appear to schedule timers
with a monotonic clock, and do not attempt to conceal a backwards time jump when calling
<code>Date.getTime()</code>. Safari 4.0.4 and 3.1.2 on Windows does not appear to schedule timers with
a monotonic clock, so they stop just like Chromium on Linux/Mac.

</div>

<div id="log"></div>

<script>
var startTime = new Date().getTime();
function append(msg) {
	var now = new Date().getTime();
	var textnode = document.createTextNode('[' + (now - startTime)/1000 + 's] ' + now + ' ' + msg);
	var br = document.createElement("br");
	var logd = document.getElementById('log');
	logd.appendChild(textnode);
	logd.appendChild(br);
}

function forcePrintout() {
	append('forced');
}

append('Logger works.');


var method;
if(String(window.location).indexOf('?setInterval') != -1) {
	method = 'setInterval'
} else {
	method = 'setTimeout';
}

append('Using method ' + method);

var count = 0;
var max = 2 * 3600; // stop after "2 hours"
function next() {
	count += 1;
	append('');
	if(count < max) {
		if(method == 'setTimeout') {
			setTimeout(next, 1000);
		}
	} else {
		append('Done');
	}
}

if(method == 'setTimeout') {
	setTimeout(next, 1000);
} else {
	setInterval(next, 1000);
}

</script>
</body>
</html>
