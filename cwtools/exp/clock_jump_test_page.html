<!doctype html>
<html>
<head>
	<meta http-equiv="charset" content="text/html; charset=utf-8">
	<title>Chromium backwards time jump</title>
	<style>
		* {
			font-family: Tahoma, Verdana, sans-serif;
			font-size: 13px;
		}
		pre, code {
			font-family: Consolas, monospace;
			font-size: 0.8em;
		}
		body, html {
			background-color: #eee;
		}
		#log {
			white-space: pre;
		}
		#doc, .info {
			white-space: pre-wrap;
		}
		table {
			border: 1px solid #aaa;
			border-collapse: collapse;
		}
	</style>
</head>
<body>
<div id="results">
	<b>Results from manual testing on 2010-03-08:</b>
	<table border=1><tr>
		<td>Browser</td>
		<td>OS; VW means<br>VMware Workstation 7.0.1</td>
		<td>setTimeout/setInterval<br>(backward clock jump)</td>
		<td>setTimeout/setTimeout<br>(forward clock jump)</td>
	</tr><tr>
		<td>IE 8.0.6001.18702 in IE8 mode</td>
		<td>XP SP3 32-bit (VW)</td>
		<td>Timer OK, getTime jumps</td>
		<td>Timer OK, getTime jumps</td>
	</tr><tr>
		<td>IE 8.0.6001.18702 in IE7 mode</td>
		<td>XP SP3 32-bit (VW)</td>
		<td>Timer OK, getTime jumps</td>
		<td>Timer OK, getTime jumps</td>
	</tr><tr>
		<td>IE 6.0.2900.5512.xpsp_sp3_gdr.090206-1234</td>
		<td>XP SP3 32-bit (VW)</td>
		<td>Timer OK, getTime jumps</td>
		<td>Timer OK, getTime jumps</td>
	</tr><tr>
		<td>Opera 10.50</td>
		<td>XP SP3 32-bit (VW)</td>
		<td>Timer OK, getTime jumps</td>
		<td>Timer OK, getTime jumps</td>
	</tr><tr>
		<td>Firefox 2.0.0.20</td>
		<td>XP SP3 32-bit (VW)</td>
		<td>Timer OK, getTime jumps; setInterval is PROBLEMATIC(#3)</td>
		<td>Timer OK, getTime jumps</td>
	</tr><tr>
		<td>Firefox 3.0.7</td>
		<td>XP SP3 32-bit (VW)</td>
		<td>Timer OK, getTime jumps; setInterval is PROBLEMATIC(#3)</td>
		<td>Timer OK, getTime jumps</td>
	</tr><tr>
		<td>Firefox 3.6</td>
		<td>XP SP3 32-bit (VW)</td>
		<td>Timer OK, getTime jumps; setInterval is PROBLEMATIC(#3)</td>
		<td>Timer OK, getTime jumps</td>
	</tr><tr>
		<td>Chrome 4.1.249.1025 beta (40600)</td>
		<td>XP SP3 32-bit (VW)</td>
		<td>Timer PROBLEMATIC(#1), getTime typically moves monotonically</td>
		<td>Timer OK, getTime jumps</td>
	</tr><tr>
		<td>Chrome 5.0.342.2 dev</td>
		<td>XP SP2 64-bit (VW)</td>
		<td>Timer PROBLEMATIC(#1), getTime typically moves monotonically</td>
		<td>Timer OK, getTime jumps</td>
	</tr><tr>
		<td>Chrome 4.0.249.89 (38071)</td>
		<td>Server 2008 R2 64-bit</td>
		<td>Timer PROBLEMATIC(#1), getTime typically moves monotonically</td>
		<td>Timer OK, getTime jumps</td>
	</tr><tr>
		<td>Safari 4.0.4</td>
		<td>XP SP3 32-bit (VW)</td>
		<td>Timer PROBLEMATIC(#2), getTime jumps</td>
		<td>Timer OK, getTime jumps</td>
	</tr><tr>
		<td>Safari 3.1.2</td>
		<td>XP SP3 32-bit (VW)</td>
		<td>Timer PROBLEMATIC(#2), getTime jumps</td>
		<td>Timer OK, getTime jumps</td>
	</tr><tr>
		<td>Opera 10.10</td>
		<td>Ubuntu 9.10 32-bit (VW)</td>
		<td>Timer OK, getTime jumps</td>
		<td>Timer OK, getTime jumps</td>
	</tr><tr>
		<td>Chrome 5.0.307.11 beta</td>
		<td>Ubuntu 9.10 32-bit (VW)</td>
		<td>Timer DELAYED, getTime jumps</td>
		<td>Timer OK, getTime jumps</td>
	</tr><tr>
		<td>Firefox 3.5.8</td>
		<td>Ubuntu 9.10 32-bit (VW)</td>
		<td>Timer DELAYED, getTime jumps</td>
		<td>Timer OK, getTime jumps</td>
	</tr><tr>
		<td>Arora 0.10.1</td>
		<td>Ubuntu 9.10 32-bit (VW)</td>
		<td>Timer DELAYED, getTime jumps</td>
		<td>Timer OK, getTime jumps</td>
	</tr><tr>
		<td>Midori 0.1.9</td>
		<td>Ubuntu 9.10 32-bit (VW)</td>
		<td>Timer DELAYED, getTime jumps</td>
		<td>Timer OK, getTime jumps</td>
	</tr><tr>
		<td>Opera 10.10</td>
		<td>Mac OS X 10.6.2</td>
		<td>Timer OK, getTime jumps</td>
		<td>Timer OK, getTime jumps</td>
	</tr><tr>
		<td>Safari 4.0.4</td>
		<td>Mac OS X 10.6.2</td>
		<td>Timer PROBLEMATIC(#2), getTime jumps</td>
		<td>Timer OK, getTime jumps</td>
	</tr><tr>
		<td>Firefox 3.6</td>
		<td>Mac OS X 10.6.2</td>
		<td>Timer DELAYED, getTime jumps</td>
		<td>Timer OK, getTime jumps</td>
	</tr><tr>
		<td>Chrome 5.0.307.11 beta</td>
		<td>Mac OS X 10.6.2</td>
		<td>Timer DELAYED, getTime jumps</td>
		<td>Timer OK, getTime jumps</td>
	</tr>
</table>
<div class="info">
<b>Instructions:</b> Adjust your system clock forward or backwards and see what
happens. Scroll down to see if the timer is firing. Click the button to print the time if
the timer is failing to fire. Append ?setInterval to this page URL use setInterval
instead of setTimeout. <b>VMWare note:</b> Since you are manually adjusting the
clock, you want to disable 'Time synchronization between the virtual machine' (click the
VMWare Tools icon).

For backward time jumps, <b>OK</b> means that timers appear to be completely
unaffected by the system time.

For foward time jumps, <b>OK</b> means that the timers still fired. (I did not test
whether they fired too early.)

The <b>DELAYED</b> browsers appear to schedule timers exactly by the system time.
If you move the clock back, then forward again into the timer firing zone, they will fire
the timer. Sometimes, you'll need to click on the browser to get the timer to fire after moving the clock forward.
This is probably because the browser's event loop is sleeping (this happened in Firefox 3.6 on Mac).

As the table shows, Opera is the only browser that is <b>OK</b> on Windows/Mac/Linux.

(#1) Chromium/Windows is strange. If you move the clock back 2 minutes, this happens:
	For the next 40-50 seconds, timers fire in 1 second.
	Then, a timer is delayed by 1-3 minutes.
	After it fires, timers resume firing in 1 second.

(#2) Safari 4.0.4/3.1.2: Safari *sometimes* appears to keep timers firing when the
clock jumps back, but often they don't. I don't know why this happens. After moving it
back, moving the clock forward usually doesn't help the timers to fire. Sometimes, when
the clock moves back, a timer fires but the next one scheduled is delayed for a while:

[4.038s] 1268059008103 Mon, 08 Mar 2010 14:36:48 GMT
[5.04s] 1268059009105 Mon, 08 Mar 2010 14:36:49 GMT
[-55.581s] 1268058948484 Mon, 08 Mar 2010 14:35:48 GMT
--- no activity for a while ---
[7.078s] 1268059011143 Mon, 08 Mar 2010 14:36:51 GMT
[8.095s] 1268059012160 Mon, 08 Mar 2010 14:36:52 GMT

On Mac OS X, it doesn't seem to correct timers automatically, so the behavior
looks almost like DELAYED (but it isn't).

(#3) Firefox/Windows: setTimeout works good, but setIntervals are scheduled way
too far in the future after the clock jumps back. There's possibly some sort
of overflow in the Firefox internals.

</div>
</div>



<div id="log"></div>

<button style="float:right" onclick="printout()"><b>Print current time</b></button>

<script>
var startTime = new Date().getTime();
function append(msg) {
	var now = new Date().getTime();
	var textnode = document.createTextNode(
		'[' + (now - startTime)/1000 + 's] ' + now + ' ' + new Date(now).toUTCString() + ' ' + msg);
	var br = document.createElement("br");
	var logd = document.getElementById('log');
	logd.appendChild(textnode);
	logd.appendChild(br);
}

function printout() {
	append('you clicked');
}

append('Logger works.');


var method;
if(String(window.location).indexOf('?setInterval') != -1) {
	method = 'setInterval'
} else {
	method = 'setTimeout';
}

append('Using method ' + method);

var count = 0;
var max = 2 * 3600; // stop after "2 hours"
function next() {
	count += 1;
	append('');
	if(count < max) {
		if(method == 'setTimeout') {
			setTimeout(next, 1000);
		}
	} else {
		if(method == 'setInterval') {
			clearInterval(intervalTicket);
		}
		append('Done');
	}
}

if(method == 'setTimeout') {
	setTimeout(next, 1000);
} else {
	var intervalTicket = setInterval(next, 1000);
}

</script>
</body>
</html>
