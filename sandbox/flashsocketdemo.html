<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
	  "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>

<style type="text/css">
embed.hidden,
object.hidden {
    height: 1px;
    width: 1px;
    position: absolute;
    top: -1000px;
    left: -1000px;
}
</style>


<head>
<body>
<object
    id="socket_bridge" class="hidden"
    classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000">
    <param name="movie" value="/js/socket_bridge.swf?onloadcallback=test" />
    <param name="allowScriptAccess" value="always" />
    <embed
        class="hidden"
        src="/js/socket_bridge.swf?onloadcallback=test"
        allowScriptAccess="always"
        type="application/x-shockwave-flash">
    </embed>
</object>
<div id="messages"></div>
<textarea id="datapanel" style="width: 500px; height: 300px;">
</textarea>
<script type="text/javascript">
alreadyRun = false;
window.connected = [];
window.numConnected = 0;
howmany = 50; // 1000 for max test

function log(m) {
	if(window.console && console.log) {
		console.log(m);
	}
}

function test() {
	//    var script = document.createElement('script');
	//    script.type = 'text/javascript';
	//    script.src = 'makefile.js';
	//    document.getElementsByTagName("head")[0].appendChild(script);

	if(alreadyRun) {
		return;
	}

	alreadyRun = true;

	for(var i=0; i < howmany; i++) {
		log(i);
		var s = new FlashSocket({
			on_data: function(data) {
				log('socket', this, 'got data');
				//document.getElementById('datapanel').value += data;
			},
			on_io_error: function(msg) {
				log("IO ERROR: "+msg);
			},
			on_security_error: function(msg) {
				log("SECURITY ERROR: "+msg);
			},
			on_close: function(msg) {
				window.numConnected -= 1;
				log("Connection closed.");
			},
			on_connect: function() {
				// if we don't do this, Firefox may keep textarea contents from previous page load.
				document.getElementById('datapanel').value = '';

				window.numConnected += 1;

				window.connected.push(this);
			}
		});
		s.connect('linux320', 444);
	}
}

started = false;

function report() {
	log('Connected:', window.numConnected);
	if(window.numConnected === 0) {
		document.getElementById('messages').innerHTML += ('0 connections.' + '<br>');
	}
	if(window.numConnected === howmany) {
		document.getElementById('messages').innerHTML += (window.numConnected + ' connections.' + '<br>');
		if(!started) {
			started = true;
			writeAll();
		}
	}
	setTimeout(report, 1000);
};

function writeAll() {
	numSockets = window.connected.length;
	while(numSockets--) {
		window.connected[numSockets].write("GET /tests/ HTTP/1.0\r\nHost: linux320\r\n\r\n");
	}
}

setTimeout(report, 250);
</script>
<br><br>
<!--old demo: Try holding down Ctrl-Shift-R. If browser or page is misbehaving, the textarea contents will occasionally be empty. If Firebug is enabled, it will cause problems (empty textarea) - tested with 1.4a12.
-->
This page demonstrates that Flash allows opening at least a thousand connections.<br><br>

Max tested was 1000.<br><br>

Firefox limit: 1000<br>
IE limit: 1000<br>
Safari 4: 1000<br>
Chrome: 1000, though slower to connect than the other browsers (IE is fast, it seems).<br>
Opera 10 limit: starts choking in the 200-400 range. Sometimes it opens all, but can't get all data quickly like other browsers. Possibly related to some other limit, not the browser's socket functionality.<br>
Opera 9: similar/identical to Opera 10.<br><br>
</body>
</html>
